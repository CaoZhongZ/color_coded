#!/bin/bash

# Re-invoke the configure script
# and keep the output at bay.
if [ "$1" != "quiet" ];
then
  $0 "quiet" $@ > /dev/null
  exit $?
fi
shift

set -o errexit
set -o nounset

# Determine system
uname_linux=0
uname_cygwin=0
uname_osx=0
uname_arch=$(uname -m)
uname=$(uname)
if [ "$uname" = "Linux" ];
then
  uname_linux=1
elif [ "$uname" = "Darwin" ];
then
  uname_osx=1
elif [ "$(uname -o)" = "Cygwin" ];
then
  uname_cygwin=1
else
  echo "Invalid uname ($uname): unsuppported platform" 1>&2
  exit 1
fi

log() { echo "$@" 1>&2; }
log_start() { printf "$@" 1>&2; }
log_end() { echo "$@" 1>&2; }
log_exit() { echo "$@" 1>&2; exit 1; }

project=color_coded
log "Configuring ${project}"

cxx_platform_flags=
ld_platform_libs=

# Project-specific flags
clang=0
gcc=0

set +o errexit
  c++ -v 2>&1 | egrep "clang version|LLVM" 2>&1 > /dev/null
  if [ $? -eq 0 ];
  then
    clang=1
    cxx_platform_flags="-stdlib=libc++ -I/opt/local/include"$cxx_platform_flags
    ld_platform_libs="-L/opt/local/lib "$ld_platform_libs"-lc++ -framework CoreFoundation"
  fi

  c++ -v 2>&1 | grep "gcc version" 2>&1 > /dev/null
  if [ $? -eq 0 ];
  then
    gcc=1
  fi

  [[ $clang -eq 0 && $gcc -eq 0 ]] && log_exit "unknown compiler: c++"
set -o errexit

[ 1 -eq $uname_linux ] && log "Platform: Linux"
[ 1 -eq $uname_osx ] && log "Platform: OS X"
[ 1 -eq $uname_cygwin ] && log "Platform: Cygwin (NOT TESTED)"

function show_help
{
  log "Usage: $0 [OPTION...]"
  log
  log "General:"
  log "  -h, --help                                   Show this help message"
  log
  exit 0
}

# Parse params
for i in "$@"
do
  case $i in
    -h)
      show_help
      ;;
    --help*)
      show_help
      ;;

    *)
      # Unknown option
      ;;
  esac
done

# Update after params
log
[ 1 -eq $gcc ] && log "Compiler: gcc"
[ 1 -eq $clang ] && log "Compiler: clang"
log "CXX platform flags: ${cxx_platform_flags:-"none"}"
log "LD platform flags: ${ld_platform_libs:-"none"}"
log

log_start "Updating submodules..."
log_end " done"

log_start "Downloading clang..."
clang_url="http://llvm.org/releases/3.4"

if [ 1 -eq $uname_osx ];
then
  clang_dirname="clang+llvm-3.4-x86_64-apple-darwin10.9"
  clang_md5="4f43ea0e87090ae5e7bec12373ca4927"
  clang_filename="${clang_dirname}.tar.gz"
else
  if [ "x86_64" == "${uname_arch}" ];
  then
    clang_dirname="clang+llvm-3.4-x86_64-unknown-ubuntu12.04"
    clang_md5="6077459d20a7ff412eefc6ce3b9f5c85"
    clang_filename="${clang_dirname}.tar.xz"
  else
    log "No pre-built Clang 3.4 binaries for 32 bit linux, downloading Clang 3.3"
    clang_url="http://llvm.org/releases/3.3"
    clang_dirname="clang+llvm-3.3-i386-debian6"
    clang_md5="415d033b60659433d4631df894673802"
    clang_filename="${clang_dirname}.tar.bz2"
  fi
fi

clang_final_filename="./${clang_filename}"
if [ ! -f $clang_final_filename ];
then
  log_end
  curl -o $clang_final_filename -# "${clang_url}/${clang_filename}" 

  log_start "Validating md5..."
  rm -f clang_md5
  echo "$clang_md5 $clang_final_filename" > clang_md5
  set +o errexit
    md5sum -c clang_md5 2>&1 > /dev/null
    result=$?
  if [ $result -ne 0 -a "$(md5 -q $clang_final_filename 2> /dev/null || true)" != $clang_md5 ];
  then
    log_exit " failed! (remove $clang_final_filename and try to configure again)"
  fi
  set -o errexit
  rm -f clang_md5
  log_end " done"

  log_start "Extracting..."
  tar xf $clang_final_filename
  log_end " done"
else
  log_end " already downloaded!"
fi
if [ ! -d $clang_dirname ];
then
  log "Invalid clang setup!"
  log_exit "Remove $clang_final_filename and try to configure again"
fi
cxx_platform_flags="-I${clang_dirname}/include "$cxx_platform_flags
ld_platform_libs="-L${clang_dirname}/lib "$ld_platform_libs

# Configure the makefile
log_start "Populating Makefile..."
rm -f Makefile
sed "s#%CXX_PLATFORM_FLAGS%#${cxx_platform_flags}#" ./Makefile.in |\
sed "s#%LD_PLATFORM_LIBS%#${ld_platform_libs}#" > Makefile
log_end " done"

log "Done configuring ${project}"

# Describe next steps
log
log "To run compile, use \`make\`"
