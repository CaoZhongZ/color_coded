CXX ?= c++
CXX_WARN = -Wall -Wextra -pedantic
CXX_NOWARN =
CXX_OPT = -O3
CXX_MISC = -fpic
CXX_INCLUDE = -Iinclude
CXX_PLATFORM_FLAGS = %CXX_PLATFORM_FLAGS%
CXX_FLAGS = -std=c++1y ${CXX_WARN} ${CXX_NOWARN} ${CXX_OPT} \
						${CXX_MISC} ${CXX_PLATFORM_FLAGS} ${CXX_INCLUDE} 

LD_PLATFORM_LIBS = %LD_PLATFORM_LIBS%
LD_LIBS = ${LD_PLATFORM_LIBS} -lclang -llua -lboost_system -lboost_filesystem

PROJECT = %PROJECT%

OUT_DIR = bin/
OBJ_DIR = ${OUT_DIR}obj/
TARGET = ${OUT_DIR}color_coded.so

OBJS := $(patsubst %.cpp,%.cpp.o,$(wildcard src/*.cpp))
OBJS := $(filter-out ${EXCLUDE},${OBJS})
SRCS := ${OBJS:.cpp.o=.cpp}
OUT_OBJS := $(foreach obj,${OBJS}, ${OBJ_DIR}${obj})

log = echo "$(1)" 1>&2

all: ${TARGET}

${TARGET}_setup: setup
	$(call log,"Building ${TARGET}")

${TARGET}: ${TARGET}_setup ${OBJS}
	$(call log,"Linking $@")
	${CXX} -shared ${CXX_FLAGS} ${OUT_OBJS} ${LD_LIBS} -o $@

setup:
	mkdir -p ${OBJ_DIR} ${OUT_DIR}

%.cpp.o: %.cpp
	$(call log,"  Compiling $<")
	mkdir -p ${OBJ_DIR}$(dir $<)
	${CXX} -c ${CXX_FLAGS} $< -o ${OBJ_DIR}$@

# For internal use only
run:
	gvim --noplugin -c "let g:color_coded_debug=1" -c ":source ${PWD}/plugin/color_coded.vim" test/simple.cpp

run_real:
	gvim --noplugin -c "let g:color_coded_debug=1" -c ":source ${PWD}/plugin/color_coded.vim" src/main.cpp

.SILENT:

.PHONY: all setup ${TARGET}_setup run run_real run_stress
run_stress:
	gvim --noplugin -c "let g:color_coded_debug=1" -c ":source ${PWD}/plugin/color_coded.vim" test/stress.hpp

%.cpp.o: %.cpp
	$(call log,"  Compiling $<")
	mkdir -p ${OBJ_DIR}$(dir $<)
	${CXX} -c ${CXX_FLAGS} $< -o ${OBJ_DIR}$@
